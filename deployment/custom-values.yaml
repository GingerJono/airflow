########################################
## CONFIG | Airflow Configs
########################################
airflow:
  ## configs for the airflow container image
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/configuration/airflow-version.md
  image:
    repository: commondalintairflowcontainerregistry.azurecr.io/dalint-airflow
    tag: "80d5287f9b6f2beafc0dd3a7c3276715b748e799"
    
    ## WARNING: even if set to "Always" DO NOT reuse tag names, 
    ##          containers only pull the latest image when restarting
    pullPolicy: IfNotPresent

  ## the airflow executor type to use
  executor: KubernetesExecutor

  ## the fernet encryption key (sets `AIRFLOW__CORE__FERNET_KEY`)
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/security/set-fernet-key.md
  ## [WARNING] change from default value to ensure security
  fernetKey: "XEiAgDDHM-HN4wdVYSAclBCqywHnotYuKrH35FkXoi4="

  ## the secret_key for flask (sets `AIRFLOW__WEBSERVER__SECRET_KEY`)
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/security/set-webserver-secret-key.md
  ## [WARNING] change from default value to ensure security
  webserverSecretKey: "DI6LI2gMsgJsxQXbCniYOnLTqWJfJ/pbHDv9QJfddBy1E7DjAnOcAuc8UZYrOawV"

  ## environment variables for airflow configs
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/configuration/airflow-configs.md
  config:
    ## security
    AIRFLOW__WEBSERVER__EXPOSE_CONFIG: "False"
    
    ## dags
    AIRFLOW__CORE__LOAD_EXAMPLES: "False"
    
    ##
    AIRFLOW__WEBSERVER__BASE_URL: "/airflow"
    
    ## Configure Email logging
    AIRFLOW__LOGGING__REMOTE_BASE_LOG_FOLDER: "wasb-airflow-logs"
    AIRFLOW__LOGGING__REMOTE_LOGGING: "True"
    AIRFLOW__LOGGING__REMOTE_LOG_CONN_ID: "wasb-airflow-logs"
    AIRFLOW__REMOTE_WASB_LOG_CONTAINER: "wasb-logging"
    
    # AIRFLOW__CORE__TEST_CONNECTION: "Enabled"
    
  ## a list of users to create
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/security/airflow-users.md
  users:
    - username: admin
      password: ${ADMIN_PASSWORD}
      role: Admin
      email: admin@example.com
      firstName: admin
      lastName: admin
    
    - username: jon-oneill
      password: ${JONO_PASSWORD}
      role: User
      email: jononeill@daleuw.com
      firstName: Jon
      lastName: "O'Neill"
    
    - username: becky-carter
      password: ${BECKY_PASSWORD}
      role: 
       - User
       - Op
      email: becky.carter@softwire.com
      firstName: Becky
      lastName: Carter
      
    - username: simon-stjohngreen
      password: ${SIMON_PASSWORD}
      role: 
       - User
       - Op
      email: simon.stjohn-green@softwire.com
      firstName: Simon
      lastName: "St John-Green"
      
    - username: matthew-english
      password: ${MATTHEW_PASSWORD}
      role: 
       - User
       - Op
      email: matthew.english@softwire.com
      firstName: Matthew
      lastName: English
      
    - username: conor-bleakley
      password: ${CONOR_PASSWORD}
      role: 
       - User
       - Op
      email: conor.bleakley@softwire.com
      firstName: Conor
      lastName: Bleakley
  
  usersTemplates:
    ADMIN_PASSWORD:
      kind: secret
      name: airflow-admin-user-details
      key: password
    
    JONO_PASSWORD:
      kind: secret
      name: jon-oneill-user-details
      key: password
    
    BECKY_PASSWORD:
      kind: secret
      name: becky-carter-user-details
      key: password
    
    SIMON_PASSWORD:
      kind: secret
      name: simon-stjohngreen-user-details
      key: password
    
    MATTHEW_PASSWORD:
      kind: secret
      name: matthew-english-user-details
      key: password
    
    CONOR_PASSWORD:
      kind: secret
      name: conor-bleakley-user-details
      key: password
      
  ## a list airflow connections to create
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/dags/airflow-connections.md
  connections:
    - id: "wasb-airflow-logs"
      type: "wasb"
      description: "Azure Blob Storage connection for logging"
      ## this string template is defined by `airflow.connectionsTemplates.CLIENT_ID`
      login: "${CLIENT_ID}"
      ## this string template is defined by `airflow.connectionsTemplates.AIRFLOW_STORAGE_HOST`
      host: "${AIRFLOW_STORAGE_HOST}"
      ## this string template is defined by `airflow.connectionsTemplates.CLIENT_SECRET`
      password: "${CLIENT_SECRET}"
      ## this string template is defined by `airflow.connectionsTemplates.TENANT_ID`
      extra: |
        {
          "extra__wasb__tenant_id": "${TENANT_ID}"
        }
        
    - id: "wasb"
      type: "wasb"
      description: "Azure Blob Storage connection for storing data between tasks."
      ## this string template is defined by `airflow.connectionsTemplates.CLIENT_ID`
      login: "${CLIENT_ID}"
      ## this string template is defined by `airflow.connectionsTemplates.AIRFLOW_STORAGE_HOST`
      host: "${AIRFLOW_STORAGE_HOST}"
      ## this string template is defined by `airflow.connectionsTemplates.CLIENT_SECRET`
      password: "${CLIENT_SECRET}"
      ## this string template is defined by `airflow.connectionsTemplates.TENANT_ID`
      extra: |
        {
          "extra__wasb__tenant_id": "${TENANT_ID}"
        }
        
    - id: "microsoft_graph"
      type: "msgraph"
      description: "Microsoft Graph connection for interacting with Emails."
      
      login: "${MS_GRAPH_CLIENT_ID}"
      password: "${MS_GRAPH_CLIENT_SECRET}"
      
      extra: |
        {
          "tenant_id": "${TENANT_ID}",
          "api_version": "v1.0",
          "extra__msgraph__scopes": "[\"https://graph.microsoft.com/.default\"]"
        }

      client_id:
      client_secret:
      tenant_id:
      api_version:
      scopes:
        
  connectionsTemplates:
    ## extracts the value of client_id from `Secret/azure-storage-connection-details`
    CLIENT_ID:
      kind: "secret"
      name: "azure-storage-connection-details"
      key: "client_id"
      
    ## extracts the value of client_secret from `Secret/azure-storage-connection-details`
    CLIENT_SECRET:
      kind: "secret"
      name: "azure-storage-connection-details"
      key: "client_secret"
      
    ## extracts the value of tenant_id from `Secret/azure-storage-connection-details`
    TENANT_ID:
      kind: "secret"
      name: "azure-storage-connection-details"
      key: "tenant_id"
      
    ## extracts the value of subscription_id from `Secret/azure-storage-connection-details`
    SUBSCRIPTION_ID:
      kind: "secret"
      name: "azure-storage-connection-details"
      key: "subscription_id"
      
      
    ## extracts the value of blob_host from `ConfigMap/airflow-storage`
    AIRFLOW_STORAGE_HOST:
      kind: "configmap"
      name: "airflow-storage"
      key: "blob_host"
      
    ## extracts the value of client_id from `Secret/msgraph-connection-details`
    MS_GRAPH_CLIENT_ID:
      kind: "secret"
      name: "msgraph-connection-details"
      key: "client_id"
      
    ## extracts the value of client_secret from `Secret/msgraph-connection-details`
    MS_GRAPH_CLIENT_SECRET:
      kind: "secret"
      name: "msgraph-connection-details"
      key: "client_secret"
      
    ## extracts the value of tenant_id from `Secret/msgraph-connection-details`
    MS_GRAPH_TENANT_ID:
      kind: "secret"
      name: "msgraph-connection-details"
      key: "tenant_id"
      

  ## a list airflow variables to create
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/dags/airflow-variables.md
  variables: 
    - key: "email_monitoring_mailbox"
      value: "${EMAIL_MONITORING_MAILBOX}"
    - key: "email_monitoring_client_state"
      value: "${EMAIL_MONITORING_CLIENT_STATE}"
    - key: "email_monitoring_apim_change_notification_url"
      value: "${EMAIL_MONITORING_CHANGE_NOTIFICATION_URL}"
    - key: "email_monitoring_apim_lifecycle_notification_url"
      value: "${EMAIL_MONITORING_LIFECYCLE_NOTIFICATION_URL}"
    - key: "azureai_api_key"
      value: "${AZUREAI_API_KEY}"
    - key: "azureai_endpoint"
      value: "${AZUREAI_ENDPOINT}"
      
  variablesTemplates:
  
    EMAIL_MONITORING_MAILBOX:
      kind: configmap
      name: email-monitoring-subscription-details
      key: mailbox
    
    EMAIL_MONITORING_CLIENT_STATE:
      kind: configmap
      name: email-monitoring-subscription-details
      key: client_state
    
    EMAIL_MONITORING_CHANGE_NOTIFICATION_URL:
      kind: configmap
      name: email-monitoring-subscription-details
      key: change_notification_url
    
    EMAIL_MONITORING_LIFECYCLE_NOTIFICATION_URL:
      kind: configmap
      name: email-monitoring-subscription-details
      key: lifecycle_notification_url
      
    AZUREAI_API_KEY:
      kind: configmap
      name: azureai-connection-details
      key: api_key

    AZUREAI_ENDPOINT:
      kind: configmap
      name: azureai-connection-details
      key: endpoint

  ## a list airflow pools to create
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/dags/airflow-pools.md
  pools: []

  ## extra pip packages to install in airflow Pods
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/configuration/extra-python-packages.md
  ## [WARNING] this feature is not recommended for production use, see docs
  extraPipPackages: []

  ## extra environment variables for the airflow Pods
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-environment-variables.md
  extraEnv: 
    - name: AIRFLOW__API__AUTH_BACKENDS
      value: 'airflow.api.auth.backend.basic_auth,airflow.api.auth.backend.session'
    # - name: AIRFLOW__CORE__TEST_CONNECTION
    #   value: 'True'

  ## extra VolumeMounts for the airflow Pods
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-persistent-volumes.md
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-files.md
  extraVolumeMounts: []

  ## extra Volumes for the airflow Pods
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-persistent-volumes.md
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-files.md
  extraVolumes: []

  ## configs generating the `pod_template.yaml` file for `AIRFLOW__KUBERNETES__POD_TEMPLATE_FILE`
  ## [NOTE] the `dags.gitSync` values will create a git-sync init-container in the pod
  ## [NOTE] the `airflow.extraPipPackages` will NOT be installed
  kubernetesPodTemplate:

    ## the full content of the pod-template file (as a string)
    ## [NOTE] all other `kubernetesPodTemplate.*` are disabled when this is set
    stringOverride: ""

    ## resource requests/limits for the Pod template "base" container
    ## [SPEC] https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#resourcerequirements-v1-core
    resources: {}

    ## extra pip packages to install in the Pod template
    ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/configuration/extra-python-packages.md
    ## [WARNING] this feature is not recommended for production use, see docs
    extraPipPackages: []

    ## extra VolumeMounts for the Pod template
    ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-persistent-volumes.md
    ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-files.md
    extraVolumeMounts: []

    ## extra Volumes for the Pod template
    ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-persistent-volumes.md
    ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/mount-files.md
    extraVolumes: []

###################################
## COMPONENT | Airflow Scheduler
###################################
scheduler:
  ## the number of scheduler Pods to run
  replicas: 1

  ## resource requests/limits for the scheduler Pods
  ## [SPEC] https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#resourcerequirements-v1-core
  resources: {}

  ## configs for the log-cleanup sidecar of the scheduler
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/monitoring/log-cleanup.md
  logCleanup:
    enabled: false
    retentionMinutes: 21600

  ## configs for the scheduler Pods' liveness probe
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/monitoring/scheduler-liveness-probe.md
  livenessProbe:
    enabled: true

    ## configs for an additional check that ensures tasks are being created by the scheduler
    ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/monitoring/scheduler-liveness-probe.md
    taskCreationCheck:
      enabled: false
      thresholdSeconds: 300
      schedulerAgeBeforeCheck: 180

###################################
## COMPONENT | Airflow Webserver
###################################
web:
  ## the number of web Pods to run
  replicas: 1

  ## resource requests/limits for the web Pods
  ## [SPEC] https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#resourcerequirements-v1-core
  resources: {}

  ## configs for the Service of the web Pods
  service:
    type: ClusterIP
    externalPort: 8080

  ## configs generating the `webserver_config.py` file
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/configuration/airflow-configs.md#webserver_configpy
  webserverConfig:
    ## the full content of the `webserver_config.py` file (as a string)
    stringOverride: |
      from airflow import configuration as conf
      from flask_appbuilder.security.manager import AUTH_DB
      
      # the SQLAlchemy connection string
      SQLALCHEMY_DATABASE_URI = conf.get("core", "SQL_ALCHEMY_CONN")
      
      # use embedded DB for auth
      AUTH_TYPE = AUTH_DB

    ## the name of a Secret containing a `webserver_config.py` key
    existingSecret: ""

###################################
## COMPONENT | Airflow Workers
###################################
workers:
  ## if the airflow workers StatefulSet should be deployed
  enabled: false

###################################
## COMPONENT | Triggerer
###################################
triggerer:
  ## if the airflow triggerer should be deployed
  enabled: true

  ## the number of triggerer Pods to run
  replicas: 1

  ## resource requests/limits for the triggerer Pods
  ## [SPEC] https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#resourcerequirements-v1-core
  resources: {}

  ## maximum number of triggers each triggerer will run at once (sets `AIRFLOW__TRIGGERER__DEFAULT_CAPACITY`)
  capacity: 1000

###################################
## COMPONENT | Flower
###################################
flower:
  ## if the airflow flower UI should be deployed
  enabled: false

###################################
## CONFIG | Airflow Logs
###################################
logs:
  ## the airflow logs folder
  path: /opt/airflow/logs

  ## configs for the logs PVC
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/monitoring/log-persistence.md
  persistence:
    enabled: false

###################################
## CONFIG | Airflow DAGs
###################################
dags:
  ## the airflow dags folder
  path: /opt/airflow/dags

  ## configs for the dags PVC
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/dags/load-dag-definitions.md
  persistence:
    enabled: false

  ## configs for the git-sync sidecar
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/dags/load-dag-definitions.md
  gitSync:
    enabled: false
    
    repoHost: "azure.com"
    
    repo: git@ssh.dev.azure.com:v3/DaleBI/DaleSoftwireIntegrationLayer/airflow
    branch: 89-email-integration-migration
    revision: HEAD
    
    ## the sub-path within your repo where dags are located
    ## NOTE: airflow will only see dags under this path, but the whole repo will still be synced
    repoSubPath: "/dags"
    
    ## number of seconds to wait between syncs
    ## NOTE: also sets `AIRFLOW__SCHEDULER__DAG_DIR_LIST_INTERVAL` unless overwritten in `airflow.config`
    syncWait: 60
    
    ## the max number of seconds allowed for a complete sync
    ## NOTE: if your repo takes a very long time to sync, you may need to increase this value
    syncTimeout: 120
    
    ## the number of consecutive failures allowed before aborting
    ## NOTE: if your repo regularly has intermittent failures, you may wish to set a non-0 value
    maxFailures: 0
    
    sshSecret: "airflow-ssh-git-secret"
    sshSecretKey: "id_rsa"
    
    ## NOTE: "known_hosts" verification can be disabled by setting to "" 
    sshKnownHosts: |-
      ssh.dev.azure.com ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQC7Hr1oTWqNqOlzGJOfGJ4NakVyIzf1rXYd4d7wo6jBlkLvCA4odBlL0mDUyZ0/QUfTTqeu+tm22gOsv+VrVTMk6vwRU75gY/y9ut5Mb3bR5BV58dKXyq9A9UeB5Cakehn5Zgm6x1mKoVyf+FFn26iYqXJRgzIZZcZ5V6hrE0Qg39kZm4az48o0AUbf6Sp4SLdvnuMa2sVNwHBboS7EJkm57XQPVU3/QpyNLHbWDdzwtrlS+ez30S3AdYhLKEOxAG8weOnyrtLJAUen9mTkol8oII1edf7mWWbWVf0nBmly21+nZcmCTISQBtdcyPaEno7fFQMDD26/s0lfKob4Kw8H

###################################
## CONFIG | Kubernetes Ingress
###################################
ingress:
  ## if we should deploy Ingress resources
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/ingress.md
  enabled: true
  
  apiVersion: networking.k8s.io/v1
  
  # airflow webserver ingress configs
  web:
    annotations: {}
    # host: "example.com"
    path: "/airflow"
    ## WARNING: requires Kubernetes 1.18 or later, use "kubernetes.io/ingress.class" annotation for older versions
    ingressClassName: "nginx"
    
    rules:
    - http:
        paths:
        - path: /
          pathType: Prefix
          backend:
            service:
              name: airflow-web
              port:
                number: 8080



###################################
## CONFIG | Kubernetes ServiceAccount
###################################
serviceAccount:
  ## if a Kubernetes ServiceAccount is created
  create: true

  ## the name of the ServiceAccount
  name: "airflow"

  ## annotations for the ServiceAccount
  annotations: {}

###################################
## CONFIG | Kubernetes Extra Manifests
###################################

## a list of extra Kubernetes manifests that will be deployed alongside the chart
## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/kubernetes/extra-manifests.md
extraManifests: []

###################################
## DATABASE | PgBouncer
###################################
pgbouncer:
  ## if the pgbouncer Deployment is created
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/database/pgbouncer.md
  enabled: true

  ## resource requests/limits for the pgbouncer Pods
  ## [SPEC] https://kubernetes.io/docs/reference/generated/kubernetes-api/v1.29/#resourcerequirements-v1-core
  resources: {}

  ## sets pgbouncer config: `auth_type`
  authType: md5

###################################
## DATABASE | Embedded Postgres
###################################
postgresql:
  ## if the `stable/postgresql` chart is used
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/database/embedded-database.md
  ## [WARNING] the embedded Postgres is NOT SUITABLE for production deployments of Airflow
  ## [WARNING] consider using an external database with `externalDatabase.*`
  enabled: true

  ## configs for the PVC of postgresql
  persistence:
    enabled: true
    storageClass: ""
    size: 8Gi

###################################
## DATABASE | External Database
###################################
externalDatabase:
  ## the type of external database
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/database/external-database.md
  type: postgres

###################################
## DATABASE | Embedded Redis
###################################
redis:
  ## if the `stable/redis` chart is used
  enabled: false

###################################
## DATABASE | External Redis
###################################
externalRedis:
  ## the host of the external redis
  ## [FAQ] https://github.com/airflow-helm/charts/blob/main/charts/airflow/docs/faq/database/external-redis.md
  host: localhost
